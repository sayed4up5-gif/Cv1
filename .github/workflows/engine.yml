name: Cv1
on:
  repository_dispatch:
    types: [run-live-script] # هذا هو المحرك الذي ينتظر إشارة Netlify

jobs:
  execute-automation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install System UI
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb x11vnc novnc jq

      - name: Install Dependencies
        run: |
          pip install seleniumbase undetected-chromedriver requests
          seleniumbase install chromedriver

      - name: Launch Stream & Run
        env:
          SB_URL: ${{ secrets.SB_URL }}
          SB_KEY: ${{ secrets.SB_KEY }}
          NGROK_TOKEN: ${{ secrets.NGROK_TOKEN }}
        run: |
          Xvfb :99 -screen 0 1280x1024x24 &
          export DISPLAY=:99
          sleep 2
          x11vnc -display :99 -forever -nopw -listen localhost &
          /usr/share/novnc/utils/launch.sh --vnc localhost:5900 --listen 8080 &
          
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt-get update && sudo apt-get install ngrok
          ngrok config add-authtoken $NGROK_TOKEN
          ngrok http 8080 > /dev/null &
          sleep 8
          
          LIVE_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          curl -X POST "$SB_URL/rest/v1/jobs" \
          -H "apikey: $SB_KEY" -H "Content-Type: application/json" \
          -d "{\"user_id\": \"${{ github.event.client_payload.user_id }}\", \"live_url\": \"$LIVE_URL/vnc.html?autoconnect=true\"}"
          
          echo "${{ github.event.client_payload.script_code }}" > task.py
          python task.py
